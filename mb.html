<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
    <title>Share Flex Message</title>
  </head>
  <body>
    <center>
      <p>... กำลังโหลด ...</p>
      <img src="https://image.makewebeasy.net/makeweb/0/pMrtkmxgt/APNG_images/loader1_1.gif?v=202012190947" alt="loading" width="126" height="129" />
      <p>กรุณารอสักครู่</p>
    </center>

    <script>
      window.onload = function() {
        liff.init({ liffId: "2006828731-NjVyo8jM" })
          .then(() => {
            if (liff.isLoggedIn()) {
              dolink();
            } else {
              liff.login();
            }
          })
          .catch(err => console.error('LIFF Initialization failed ', err));
      };


      function getParameterByName(name, url = window.location.href) {
        name = name.replace(/[\[\]]/g, '\\$&');
        const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
        const results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
      }

      async function fetchDataFromGoogleSheet(id) {
        const url = `https://script.google.com/macros/s/AKfycbz7Iofce5Xuluw_73mBK71NPcwd7o3202oaMTIVTCIHDtR_LeEudgK3zDQn9Yrwu11D/exec?id=${id}`;
        const response = await fetch(url);
        const data = await response.json();
        return data;
      }

      function dolink() {
        const referId = getParameterByName("id");

        fetchDataFromGoogleSheet(referId).then(data => {
          if (data.error) {
            Swal.fire('Error', 'ไม่พบข้อมูลที่ต้องการ', 'error');
            return;
          }

          if (referId === getParameterByName("id")) {
            liff.shareTargetPicker([
              {
                "type": "flex",
                "altText": "สนภ.1 นทพ.",
                "contents": 
// -------ใส่ JSON ----------

{
  "type": "bubble",
  "size": "giga",
  "body": {
    "type": "box",
    "layout": "vertical",
    "contents": [
      {
        "type": "image",
        "url": "https://raw.githubusercontent.com/app-mdu25/shareflex/refs/heads/main/2.png",
        "size": "full",
        "aspectMode": "cover",
        "aspectRatio": "1:1",
        "gravity": "center"
      },
      {
        "type": "box",
        "layout": "vertical",
        "contents": [
          {
            "type": "box",
            "layout": "vertical",
            "contents": [
              {
                "type": "text",
                "text": "ตสส.นพค.25 รายงานสรุป Morning Brief",
                "color": "#ffffff",
                "size": "lg"
              },
              {
                "type": "text",
                "text": "ประจำวันที่ "+data.date,
                "color": "#FFFFFF",
                "size": "sm"
              }
            ],
            "backgroundColor": "#0064b5",
            "alignItems": "center",
            "height": "30%"
          }
        ],
        "position": "absolute",
        "background": {
          "type": "linearGradient",
          "angle": "0deg",
          "endColor": "#00000000",
          "startColor": "#00000099"
        },
        "width": "100%",
        "height": "33%",
        "offsetBottom": "0px",
        "offsetStart": "0px",
        "offsetEnd": "0px"
      },
      {
        "type": "box",
        "layout": "horizontal",
        "contents": [
          {
            "type": "box",
            "layout": "horizontal",
            "contents": [
              {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                  {
                    "type": "image",
                    "url": "https://raw.githubusercontent.com/app-mdu25/shareflex/refs/heads/main/icon_pdf_1.png",
                    "size": "sm",
                    "action": {
                      "type": "uri",
                      "label": "action",
                      "uri": data.urlpdf
                    }
                  }
                ]
              },
              {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                  {
                    "type": "image",
                    "url": "https://raw.githubusercontent.com/app-mdu25/shareflex/refs/heads/main/icon_audio_1.png",
                    "size": "sm",
                    "action": {
                      "type": "uri",
                      "label": "action",
                      "uri": data.urlaudio
                    }
                  }
                ],
                "spacing": "xs"
              },
              {
                "type": "box",
                "layout": "horizontal",
                "contents": [
                  {
                    "type": "image",
                    "url": "https://raw.githubusercontent.com/app-mdu25/shareflex/refs/heads/main/icon_ptt_1.png",
                    "size": "sm",
                    "action": {
                      "type": "uri",
                      "label": "action",
                      "uri": data.urlptt
                    }
                  }
                ]
              }
            ],
            "spacing": "xs"
          }
        ],
        "offsetBottom": "0px",
        "offsetStart": "0px",
        "offsetEnd": "0px",
        "paddingAll": "20px",
        "backgroundColor": "#333333"
      }
    ],
    "paddingAll": "0px"
  }
}
                  

// -------จบ JSON ----------

              }
            ])
            .then(function() {
              Swal.fire({
                position: 'top-center',
                icon: 'success',
                title: 'ส่งข้อมูลเรียบร้อย',
                showConfirmButton: false,
                timer: 1500,
                onClose: () => {
                  liff.closeWindow();
                }
              });
            })
            .catch(function(error) {
              console.error("Error in shareTargetPicker: ", error);
            });
          }
        }).catch(error => {
          console.error("Error fetching data: ", error);
          Swal.fire('Error', 'เกิดข้อผิดพลาดในการดึงข้อมูล', 'error');
        });
      }


    </script>

    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  </body>
</html>
